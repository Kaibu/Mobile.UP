<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Mobile.UP</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Mobile.UP</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>CampusMapQueryParams</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/pages/campus-map/campus-map.page.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#campus">campus</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#coordinates">coordinates</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#feature">feature</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="campus"></a>
                                        <span class="name"><b>campus</b><a href="#campus"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>campus:     <code>string | number</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string | number</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="coordinates"></a>
                                        <span class="name"><b>coordinates</b><a href="#coordinates"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>coordinates:     <code>LatLngExpression</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>LatLngExpression</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="feature"></a>
                                        <span class="name"><b>feature</b><a href="#feature"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>feature:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {AfterViewInit, Component, ViewChild} from &#x27;@angular/core&#x27;;
import { TranslateService } from &#x27;@ngx-translate/core&#x27;;
import { IMapsResponseObject, ICampus, IMapsResponse } from &#x27;src/app/lib/interfaces&#x27;;
import { Geolocation, PositionError } from &#x27;@ionic-native/geolocation/ngx&#x27;;
import {ModalController} from &#x27;@ionic/angular&#x27;;
import { CampusMapFeatureModalComponent } from &#x27;../../components/campus-map-feature-modal/campus-map-feature-modal.component&#x27;;
import { CampusTabComponent } from &#x27;../../components/campus-tab/campus-tab.component&#x27;;
import * as L from &#x27;leaflet&#x27;;
import &#x27;leaflet-easybutton&#x27;;
import &#x27;leaflet-rotatedmarker&#x27;;
import &#x27;leaflet-search&#x27;;
import { AbstractPage } from &#x27;src/app/lib/abstract-page&#x27;;
import { ConfigService } from &#x27;../../services/config/config.service&#x27;;
import { WebserviceWrapperService } from &#x27;../../services/webservice-wrapper/webservice-wrapper.service&#x27;;
import { AlertService } from &#x27;src/app/services/alert/alert.service&#x27;;
import { AlertButton } from &#x27;@ionic/core&#x27;;
import {ActivatedRoute} from &#x27;@angular/router&#x27;;
import {LatLngExpression} from &#x27;leaflet&#x27;;

export interface CampusMapQueryParams {
  campus?: string | number;
  feature?: string;
  coordinates?: LatLngExpression;
}

@Component({
  selector: &#x27;app-campus-map&#x27;,
  templateUrl: &#x27;./campus-map.page.html&#x27;,
  styleUrls: [&#x27;./campus-map.page.scss&#x27;],
})
export class CampusMapPage extends AbstractPage implements AfterViewInit {

  campusList: ICampus[] &#x3D; ConfigService.config.campus;
  currentCampus: ICampus;
  geoJSON: IMapsResponseObject[];
  searchControl;
  searchableLayers: L.LayerGroup &#x3D; L.layerGroup();
  map: L.Map;

  positionCircle: L.Circle;
  positionMarker: L.Marker;
  latestHeading: number;

  geoLocationWatch;
  geoLocationEnabled &#x3D; false;
  @ViewChild(CampusTabComponent) campusTab: CampusTabComponent;

  constructor(
    private ws: WebserviceWrapperService,
    private route: ActivatedRoute,
    private translate: TranslateService,
    private location: Geolocation,
    private modalCtrl: ModalController,
    private alertService: AlertService
  ) {
    super({ optionalNetwork: true });
  }

  /**
   * @name loadMap
   * @description loads map and initializes it
   */
  initializeLeafletMap() {
    // create map object
    const map &#x3D; L.map(&#x27;map&#x27;);
    L.tileLayer(
      &#x27;http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#x27;, {
        attribution: &#x27;www.uni-potsdam.de&#x27;,
        maxZoom: 18
      }).addTo(map);
    return map;
  }

  /**
   * implementation of abstract page function
   * @param params
   */
  handleQueryParams(params: CampusMapQueryParams) {
    this.logger.entry(&#x27;handleQueryParams&#x27;, params);
    if (params.coordinates) {
      this.moveToPosition(params.coordinates);
    }

    if (params.feature) {
      this.moveToFeature(params.feature);
    }

    if (params.campus) {
      this.moveToQueriedCampus(params.campus);
    }
  }

  /**
   * @name ionViewWillEnter
   * @desc take user to login if there is no session.
   * We are using ionViewDidEnter here because it is run every time the view is
   * entered, other than ionViewDidLoad which will run only once
   */
  ngAfterViewInit () {
    // initialize map
    if (!this.map) {
      this.map &#x3D; this.initializeLeafletMap();

      // if the currentCampus has been set already, move there
      if (this.currentCampus) {
        this.moveToCampus(this.currentCampus);
      }

      this.loadMapData(this.map);
      this.addLeafletSearch(this.map);
      this.addGeoLocationButton(this.map);
    }
    // trigger pageReadyResolve, need to wait a second until map is really ready
    // TODO: find out why this timeout is necessary and find better solution
    setTimeout(
      () &#x3D;&gt; this.pageReadyResolve(),
      1000
    );
  }

  /**
   * @name addLeafletSearch
   * @desc Adds the leaflet search control to the map. Will only work if
   * this.searchableLayers is already populated with geoJSON objects.
   */
  addLeafletSearch(map) {
    this.searchControl &#x3D; new L.Control[&#x27;Search&#x27;]({
      layer: this.searchableLayers,
      propertyName: &#x27;searchProperty&#x27;,
      collapsed: false,
      textErr: this.translate.instant(&#x27;page.campus-map.no_results&#x27;),
      textCancel: this.translate.instant(&#x27;page.campus-map.cancel&#x27;),
      textPlaceholder: this.translate.instant(&#x27;page.campus-map.placeholder_search&#x27;),
      initial: false,
      minLength: 3,
      autoType: false, // guess that would just annoy most users,
      buildTip: (text, val) &#x3D;&gt; {
        const tip &#x3D; L.DomUtil.create(&#x27;li&#x27;, &#x27;&#x27;);
        const properties &#x3D; val.layer.feature.properties;
        if (properties.Name &amp;&amp; properties.campus.pretty_name) {
          let content &#x3D; &#x60;&lt;div id&#x3D;&quot;tooltip-title&quot;&gt;${properties.Name} (${properties.campus.pretty_name})&lt;/div&gt;&#x60;;
          if (properties.description) {
            content +&#x3D; &#x60;&lt;div id&#x3D;&quot;tooltip-description&quot;&gt;${properties.description.replace(/\n/g, &#x27;&lt;br&gt;&#x27;)}&lt;/div&gt;&#x60;;
          }

          tip.innerHTML &#x3D; content;
          L.DomUtil.addClass(tip, &#x27;search-tip&#x27;);
          tip[&#x27;_text&#x27;] &#x3D; content;
        }

        return tip;
      }
    });
    map.addControl(this.searchControl);
  }

  /**
   * @name addGeoLocationButton
   * @desc adds geolocation button to map
   */
  addGeoLocationButton(map) {
    const toggleGeolocationButton &#x3D; L.easyButton({
      states: [{
        stateName: &#x27;geolocation-disabled&#x27;,
        icon: &#x27;&lt;ion-icon style&#x3D;&quot;font-size: 1.4em; padding-top: 5px;&quot; name&#x3D;&quot;locate&quot;&gt;&lt;/ion-icon&gt;&#x27;,
        title: this.translate.instant(&#x27;page.campus-map.enable_geolocation&#x27;),
        onClick: (control) &#x3D;&gt; {
          const enableCallback &#x3D; () &#x3D;&gt; {
            this.geoLocationEnabled &#x3D; true;
            control.state(&#x27;geolocation-enabled&#x27;);
          };
          const disableCallback &#x3D; () &#x3D;&gt; {
            this.geoLocationEnabled &#x3D; false;
            control.state(&#x27;geolocation-disabled&#x27;);
          };
          this.enableGeolocation(enableCallback, disableCallback);
        }
      }, {
        stateName: &#x27;geolocation-enabled&#x27;,
        icon: &#x27;&lt;ion-icon style&#x3D;&quot;font-size: 1.4em; padding-top: 5px;&quot; name&#x3D;&quot;close-circle&quot;&gt;&lt;/ion-icon&gt;&#x27;,
        title: this.translate.instant(&#x27;page.campus-map.disable_geolocation&#x27;),
        onClick: (control) &#x3D;&gt; {
          this.disableGeolocation();
          control.state(&#x27;geolocation-disabled&#x27;);
        },
      }]
    });
    toggleGeolocationButton.addTo(map);
  }

  /**
   * @name setPosition
   * @desc adds a leaflet circle to the map at the given position with a radius
   * fitting the positions accuracy. Also adds a marker if we know where the device
   * is heading.
   * @param position {Position}
   */
  setPosition(position: Position) {
    // remove existing circle, if there is one
    if (this.positionCircle) {
      this.map.removeLayer(this.positionCircle);
    }
    if (this.positionMarker) {
      this.map.removeLayer(this.positionMarker);
    }

    // if we are currently heading somewhere, use this value, otherwise use
    // the last recent direction
    if ((position &amp;&amp; position.coords &amp;&amp; position.coords.heading) || this.latestHeading) {
      // save current value
      if (position &amp;&amp; position.coords &amp;&amp; position.coords.heading) {
        this.latestHeading &#x3D; position.coords.heading;
      }

      // TODO: don&#x27;t create this icon again and again
      const icon &#x3D; L.icon({
        iconUrl: &#x27;../assets/icon/navigate.svg&#x27;,
        iconSize: [42, 42],
        iconAnchor: [21, 21]
      });

      this.positionMarker &#x3D; L.marker(
      [position.coords.latitude, position.coords.longitude],
      {
        rotationAngle: this.latestHeading,
        icon: icon
      });
      this.positionMarker.addTo(this.map);
    }

    this.positionCircle &#x3D; L.circle(
      [position.coords.latitude, position.coords.longitude],
      {
        color: &#x27;blue&#x27;,
        fillColor: &#x27;#0000ff&#x27;,
        fillOpacity: 0.5,
        radius: position.coords.accuracy ? position.coords.accuracy : 10
      }
    );
    this.positionCircle.addTo(this.map);
  }

  /**
   * @name  enableGeolocation
   * @desc enabled retrieval of location and starts function that adds a circle
   * to the map. Returns an observable that constantly returns success when the
   * current position could be fetched and error when there was an error.
   */
  enableGeolocation(enableCallback, disableCallback) {
    this.geoLocationWatch &#x3D; this.location.watchPosition().subscribe(
      (positionResponse: Position &amp; PositionError) &#x3D;&gt; {
        if (!positionResponse.code) {
          this.setPosition(positionResponse);
          enableCallback();
        } else {
          this.logger.debug(&#x27;enableGeolocation&#x27;, &#x60;error getting position: ${positionResponse.message ? positionResponse.message : &#x27;&#x27;}&#x60;);
          disableCallback();
        }
      },
      error &#x3D;&gt; {
        this.logger.error(&#x27;enableGeolocation&#x27;, error);
        disableCallback();
      }
    );
  }

  /**
   * @name disableGeolocation
   * @desc disables geolocation by unsubscribing from watch and deleting current
   * positionCircle
   */
  disableGeolocation() {
    this.geoLocationEnabled &#x3D; false;
    if (this.positionCircle) {
      this.map.removeLayer(this.positionCircle);
    }

    if (this.positionMarker) {
      this.map.removeLayer(this.positionMarker);
    }

    this.geoLocationWatch.unsubscribe();
  }

  /**
   * @name loadMapData
   * @description loads campus map data from cache
   */
  loadMapData(map) {
    this.ws.call(&#x27;maps&#x27;).subscribe(
      (response: IMapsResponse) &#x3D;&gt; {
        this.geoJSON &#x3D; response;
        this.addFeaturesToLayerGroups(this.geoJSON, map);
      }, () &#x3D;&gt; {
        const buttons: AlertButton[] &#x3D; [{
          text: this.translate.instant(&#x27;button.continue&#x27;),
          handler: () &#x3D;&gt; {
            this.navCtrl.navigateRoot(&#x27;/home&#x27;);
          }
        }];
        this.alertService.showAlert(
          {
            headerI18nKey: &#x27;alert.title.httpError&#x27;,
            messageI18nKey: &#x27;alert.network&#x27;
          },
          buttons
        );
      }
    );
  }

  /**
   * selects the given campus and sets fitBounds to the campus&#x27; bounds
   * @param {ICampus} campus
   */
  selectCampus(campus: ICampus) {
    this.currentCampus &#x3D; campus;
    if (this.map) {
      this.moveToCampus(campus);
    }
  }

  /**
   * moves to given campus
   * @param campus {ICampus}
   */
  moveToCampus(campus: ICampus) {
    this.map.fitBounds(campus.lat_long_bounds);
  }

  /**
   * Finds a campus by query. Campus can be specified in multiple ways:
   *  - location_id (as string or number)
   *  - name
   *  - pretty_name
   * @description fits map to given campus
   * @param {string | name} query
   */
  queryCampus(query: string | number) {
    if (this.config.campus) {
      return this.config.campus.find(
        (campus: ICampus) &#x3D;&gt; {
          return campus.location_id &#x3D;&#x3D;&#x3D; query
            || campus.location_id &#x3D;&#x3D;&#x3D; query.toString()
            || campus.name &#x3D;&#x3D;&#x3D; query
            || campus.pretty_name &#x3D;&#x3D;&#x3D; query;
        }
      );
    } else { return undefined; }
  }

  /**
   * Queries the desired campus and moves there if it can be found
   * @param query
   */
  moveToQueriedCampus(query: string | number) {
    const foundCampus &#x3D; this.queryCampus(query);
    if (foundCampus) {
      this.logger.info(&#x60;moving to campus ${foundCampus.pretty_name}&#x60;);
      this.selectCampus(foundCampus);
    } else {
      this.logger.error(&#x60;could not find campus by query: &#x27;${query}&#x27;&#x60;);
    }
  }

  /**
   * move map to given feature, if it exists
   */
  moveToFeature(feature) {

  }

  /**
   * flys to given coordinates
   * @param coordinates
   */
  moveToPosition(coordinates: LatLngExpression) {
    this.logger.entry(&#x27;moveToPosition&#x27;, coordinates);
    this.map.panTo(coordinates);
  }

  /**
   * @name addFeaturesToLayerGroups
   * @description adds features of geoJSON to layerControl and adds those layerGroups
   * to the map by default
   */
  addFeaturesToLayerGroups(geoJSON: IMapsResponse, map: L.Map) {
    // just used to remember which categories we&#x27;ve seen already
    const categories: string[] &#x3D; [];

    // create a mapping of campusName to ICampus object
    const campusMapping &#x3D; {};
    for (const c of this.campusList) { campusMapping[c.name] &#x3D; c; }

    // this object will be populated next and then added to the map
    const overlays: {[name: string]: L.LayerGroup} &#x3D; {};

    for (const obj of geoJSON) {
      // create correct category string
      const category &#x3D; this.translate.instant(
        &#x27;page.campus-map.category.&#x27; + obj.category
      );

      // check if we already have this category in our overlays
      if (categories.indexOf(obj.category) &#x3D;&#x3D;&#x3D; -1) {
        // Create new LayerGroup for each unique category
        overlays[category] &#x3D; L.layerGroup();
        // Push category name so we know we already got that one
        categories.push(obj.category);
      }

      // add features from each category to corresponding layer
      for (const feature of obj.geo.features) {
        const props &#x3D; feature.properties;

        // create new property that can easily be searched by leaflet-search
        props[&#x27;campus&#x27;] &#x3D; campusMapping[obj.campus];
        props[&#x27;category&#x27;] &#x3D; category;
        props[&#x27;searchProperty&#x27;] &#x3D; &#x60;${props.Name} ${props.description ? props.description : &#x27;&#x27;} (${props.campus.pretty_name})&#x60;;
        props[&#x27;code&#x27;] &#x3D; &#x60;&#x60;;

        const geoJson &#x3D; L.geoJSON(feature);

        // add click listener that will open a Modal displaying some information
        geoJson.on(&#x27;click&#x27;, async () &#x3D;&gt; {
          if (props.campus !&#x3D;&#x3D; this.currentCampus) {
            this.currentCampus &#x3D; props.campus;
          }

          const modal &#x3D; await this.modalCtrl.create({
            // backdropDismiss: false,
            component: CampusMapFeatureModalComponent,
            componentProps: { feature: feature },
            cssClass: &#x27;campus-map-modal&#x27;,
            showBackdrop: true
          });
          modal.present();
        });

        // add this feature to the corresponding overlay catgory
        overlays[category].addLayer(geoJson);

        // also add geoJSON to list of searchable layers
        this.searchableLayers.addLayer(geoJson);
      }
    }

    // now add all created layers to the map by default
    // TODO: maybe pre-define defaults in config?
    for (const layerName in overlays) {
      if (overlays[layerName]) {
        overlays[layerName].addTo(this.map);
      }
    }

    // add control with overlays to map
    L.control.layers({}, overlays).addTo(map);
  }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'CampusMapQueryParams.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
